<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgentQA â€” AI Agent Evaluation System | Gorgias Decision Intelligence</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=IBM+Plex+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --emerald: #10b981;
            --amber: #f59e0b;
            --rose: #f43f5e;
            --violet: #8b5cf6;
            --sky: #0ea5e9;
            --slate-50: #f8fafc;
            --bg-0: #0a0a0f;
            --bg-1: #12121a;
            --bg-2: #1a1a25;
            --bg-3: #252530;
            --text-0: #eeeef0;
            --text-1: #9898a6;
            --text-2: #5e5e6e;
            --border: #2a2a35;
            --gradient: linear-gradient(135deg, #8b5cf6 0%, #0ea5e9 50%, #10b981 100%);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg-0);
            color: var(--text-0);
            min-height: 100vh;
        }

        /* Top Bar */
        .topbar {
            height: 50px;
            background: rgba(10, 10, 15, 0.9);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1.25rem;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .tb-left { display: flex; align-items: center; gap: 0.65rem; }

        .logo-sq {
            width: 30px; height: 30px;
            background: var(--gradient);
            border-radius: 7px;
            display: grid;
            place-items: center;
            font-size: 0.85rem;
            box-shadow: 0 0 18px rgba(139, 92, 246, 0.25);
        }

        .logo-t {
            font-size: 1rem;
            font-weight: 800;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .logo-s {
            font-size: 0.5rem;
            color: var(--text-2);
            text-transform: uppercase;
            letter-spacing: 2.5px;
        }

        .tb-right { display: flex; gap: 0.4rem; }

        .pill {
            padding: 0.2rem 0.55rem;
            border-radius: 5px;
            font-size: 0.58rem;
            font-family: 'IBM Plex Mono', monospace;
            background: var(--bg-2);
            border: 1px solid var(--border);
            color: var(--text-1);
        }

        .pill.on {
            background: rgba(16, 185, 129, 0.1);
            border-color: rgba(16, 185, 129, 0.3);
            color: var(--emerald);
        }

        .pill.on::before {
            content: ''; display: inline-block;
            width: 5px; height: 5px;
            background: var(--emerald);
            border-radius: 50%;
            margin-right: 4px;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%,100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* Dashboard */
        .dashboard {
            max-width: 1780px;
            margin: 0 auto;
            padding: 1.25rem;
        }

        .dash-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.25rem;
        }

        .dash-title {
            font-size: 1.3rem;
            font-weight: 800;
        }

        .dash-controls {
            display: flex;
            gap: 0.4rem;
        }

        .d-btn {
            padding: 0.45rem 0.85rem;
            background: var(--bg-2);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-1);
            font-family: 'Outfit', sans-serif;
            font-size: 0.72rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .d-btn:hover { border-color: var(--violet); color: var(--text-0); }
        .d-btn.active { background: rgba(139, 92, 246, 0.15); border-color: var(--violet); color: var(--violet); }

        /* Score Cards */
        .score-row {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 0.75rem;
            margin-bottom: 1.25rem;
        }

        @media (max-width: 1200px) {
            .score-row { grid-template-columns: repeat(3, 1fr); }
        }

        .score-card {
            background: var(--bg-1);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
            transition: all 0.25s;
        }

        .score-card:hover {
            border-color: var(--violet);
            transform: translateY(-2px);
        }

        .sc-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }

        .sc-label {
            font-size: 0.65rem;
            color: var(--text-2);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 500;
        }

        .sc-badge {
            font-size: 0.5rem;
            padding: 0.12rem 0.35rem;
            border-radius: 4px;
            font-family: 'IBM Plex Mono', monospace;
        }

        .sc-badge.up { background: rgba(16,185,129,0.12); color: var(--emerald); }
        .sc-badge.down { background: rgba(244,63,94,0.12); color: var(--rose); }
        .sc-badge.flat { background: rgba(245,158,11,0.12); color: var(--amber); }

        .sc-value {
            font-size: 2rem;
            font-weight: 800;
            font-family: 'IBM Plex Mono', monospace;
            line-height: 1;
        }

        .sc-sub {
            font-size: 0.62rem;
            color: var(--text-2);
            margin-top: 0.25rem;
        }

        .sc-bar-track {
            height: 4px;
            background: var(--bg-3);
            border-radius: 2px;
            margin-top: 0.6rem;
            overflow: hidden;
        }

        .sc-bar-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 1s cubic-bezier(0.16, 1, 0.3, 1);
        }

        /* Main Grid */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 440px;
            gap: 1rem;
        }

        @media (max-width: 1200px) { .main-grid { grid-template-columns: 1fr; } }

        .card {
            background: var(--bg-1);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
        }

        .card-h {
            padding: 0.85rem 1rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-2);
        }

        .card-t {
            font-size: 0.8rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .card-b { padding: 1rem; }

        /* Conversation Review */
        .conv-list {
            max-height: 500px;
            overflow-y: auto;
        }

        .conv-item {
            padding: 0.75rem;
            border-radius: 10px;
            background: var(--bg-2);
            margin-bottom: 0.6rem;
            cursor: pointer;
            border-left: 3px solid transparent;
            transition: all 0.2s;
        }

        .conv-item:hover { background: rgba(139, 92, 246, 0.06); }

        .conv-item.fail { border-left-color: var(--rose); }
        .conv-item.pass { border-left-color: var(--emerald); }
        .conv-item.warn { border-left-color: var(--amber); }
        .conv-item.selected { background: rgba(139, 92, 246, 0.1); border-left-color: var(--violet); }

        .ci-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.35rem;
        }

        .ci-id {
            font-size: 0.68rem;
            font-family: 'IBM Plex Mono', monospace;
            color: var(--text-1);
        }

        .ci-score {
            font-size: 0.72rem;
            font-weight: 700;
            font-family: 'IBM Plex Mono', monospace;
        }

        .ci-score.high { color: var(--emerald); }
        .ci-score.mid { color: var(--amber); }
        .ci-score.low { color: var(--rose); }

        .ci-preview {
            font-size: 0.72rem;
            color: var(--text-2);
            margin-bottom: 0.35rem;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .ci-tags { display: flex; gap: 0.25rem; flex-wrap: wrap; }

        .ci-tag {
            font-size: 0.5rem;
            padding: 0.12rem 0.35rem;
            border-radius: 3px;
            font-family: 'IBM Plex Mono', monospace;
        }

        .ci-tag.accuracy { background: rgba(14,165,233,0.12); color: var(--sky); }
        .ci-tag.tone { background: rgba(139,92,246,0.12); color: var(--violet); }
        .ci-tag.escalation { background: rgba(244,63,94,0.12); color: var(--rose); }
        .ci-tag.policy { background: rgba(245,158,11,0.12); color: var(--amber); }
        .ci-tag.upsell { background: rgba(16,185,129,0.12); color: var(--emerald); }

        /* Evaluation Detail */
        .eval-detail {
            background: var(--bg-2);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 0.75rem;
        }

        .eval-title {
            font-size: 0.78rem;
            font-weight: 600;
            margin-bottom: 0.6rem;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        /* Rubric */
        .rubric-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .rubric-item {
            background: var(--bg-0);
            border-radius: 8px;
            padding: 0.65rem;
        }

        .ri-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.35rem;
        }

        .ri-name {
            font-size: 0.65rem;
            font-weight: 500;
            color: var(--text-1);
        }

        .ri-score {
            font-size: 0.72rem;
            font-weight: 700;
            font-family: 'IBM Plex Mono', monospace;
        }

        .ri-bar {
            height: 3px;
            background: var(--bg-3);
            border-radius: 2px;
            overflow: hidden;
        }

        .ri-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.8s cubic-bezier(0.16, 1, 0.3, 1);
        }

        /* Chat Replay */
        .chat-replay {
            background: var(--bg-0);
            border-radius: 10px;
            padding: 0.75rem;
            max-height: 260px;
            overflow-y: auto;
        }

        .cr-msg {
            margin-bottom: 0.6rem;
            animation: fadeUp 0.3s ease;
        }

        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .cr-msg-customer {
            display: flex;
            gap: 0.5rem;
        }

        .cr-msg-ai {
            display: flex;
            gap: 0.5rem;
        }

        .cr-avatar {
            width: 22px; height: 22px;
            border-radius: 5px;
            display: grid;
            place-items: center;
            font-size: 0.6rem;
            flex-shrink: 0;
        }

        .cr-avatar.customer { background: var(--bg-3); }
        .cr-avatar.ai { background: var(--gradient); }

        .cr-bubble {
            padding: 0.5rem 0.7rem;
            border-radius: 8px;
            font-size: 0.72rem;
            line-height: 1.5;
            max-width: 85%;
        }

        .cr-msg-customer .cr-bubble {
            background: var(--bg-2);
            color: var(--text-1);
        }

        .cr-msg-ai .cr-bubble {
            background: rgba(139, 92, 246, 0.08);
            border: 1px solid rgba(139, 92, 246, 0.15);
            color: var(--text-0);
        }

        .cr-annotation {
            margin-left: 2rem;
            padding: 0.35rem 0.55rem;
            background: rgba(244, 63, 94, 0.08);
            border-left: 2px solid var(--rose);
            border-radius: 0 6px 6px 0;
            font-size: 0.6rem;
            color: var(--rose);
            margin-bottom: 0.5rem;
            font-family: 'IBM Plex Mono', monospace;
        }

        .cr-annotation.good {
            background: rgba(16, 185, 129, 0.08);
            border-left-color: var(--emerald);
            color: var(--emerald);
        }

        /* Trend Chart */
        .trend-chart {
            display: flex;
            align-items: flex-end;
            gap: 3px;
            height: 80px;
            padding: 0.5rem 0;
        }

        .tc-bar-group {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100%;
            justify-content: flex-end;
            gap: 2px;
        }

        .tc-bar {
            width: 100%;
            border-radius: 3px 3px 0 0;
            transition: height 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .tc-label {
            font-size: 0.45rem;
            color: var(--text-2);
            font-family: 'IBM Plex Mono', monospace;
        }

        /* Criteria breakdown */
        .criteria-breakdown {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .cb-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .cb-name {
            width: 80px;
            font-size: 0.62rem;
            color: var(--text-2);
            text-align: right;
            font-weight: 500;
        }

        .cb-bar-track {
            flex: 1;
            height: 16px;
            background: var(--bg-0);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .cb-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 1s cubic-bezier(0.16, 1, 0.3, 1);
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 6px;
        }

        .cb-val {
            font-size: 0.55rem;
            font-family: 'IBM Plex Mono', monospace;
            font-weight: 600;
            color: white;
        }

        /* Run eval button */
        .run-eval-btn {
            width: 100%;
            padding: 0.75rem;
            background: var(--gradient);
            border: none;
            border-radius: 10px;
            color: white;
            font-family: 'Outfit', sans-serif;
            font-size: 0.82rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 0.5rem;
        }

        .run-eval-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 30px rgba(139, 92, 246, 0.3);
        }

        .run-eval-btn:active { transform: translateY(0); }

        /* Edge case list */
        .edge-item {
            padding: 0.6rem;
            background: var(--bg-2);
            border-radius: 8px;
            margin-bottom: 0.4rem;
            border-left: 3px solid var(--rose);
        }

        .edge-item.resolved { border-left-color: var(--emerald); }

        .ei-title {
            font-size: 0.72rem;
            font-weight: 600;
            margin-bottom: 0.2rem;
        }

        .ei-desc {
            font-size: 0.62rem;
            color: var(--text-2);
            line-height: 1.4;
        }

        .ei-meta {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.3rem;
        }

        .ei-stat {
            font-size: 0.52rem;
            font-family: 'IBM Plex Mono', monospace;
            color: var(--text-2);
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--bg-3); border-radius: 2px; }

        /* Loading overlay */
        .eval-overlay {
            position: fixed;
            inset: 0;
            background: rgba(10, 10, 15, 0.95);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 200;
        }

        .eval-overlay.active { display: flex; }

        .eo-spinner {
            width: 60px; height: 60px;
            border: 3px solid var(--bg-3);
            border-top-color: var(--violet);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 1.25rem;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .eo-text { font-size: 0.95rem; font-weight: 600; margin-bottom: 0.3rem; }
        .eo-sub { font-size: 0.72rem; color: var(--text-2); font-family: 'IBM Plex Mono', monospace; }

        .eo-progress {
            width: 200px; height: 4px;
            background: var(--bg-3);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 1rem;
        }

        .eo-fill {
            height: 100%;
            background: var(--gradient);
            width: 0%;
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <div class="topbar">
        <div class="tb-left">
            <div class="logo-sq">ðŸ”¬</div>
            <div>
                <div class="logo-t">AgentQA</div>
                <div class="logo-s">Gorgias Decision Intelligence</div>
            </div>
        </div>
        <div class="tb-right">
            <span class="pill on">Eval Pipeline Active</span>
            <span class="pill">LLM-as-Judge</span>
            <span class="pill">LangSmith</span>
            <span class="pill">PromptLayer</span>
        </div>
    </div>

    <div class="dashboard">
        <div class="dash-header">
            <div class="dash-title">âš¡ Agent Performance Evaluation</div>
            <div class="dash-controls">
                <button class="d-btn active" onclick="setTimeRange(this, 'today')">Today</button>
                <button class="d-btn" onclick="setTimeRange(this, '7d')">7 Days</button>
                <button class="d-btn" onclick="setTimeRange(this, '30d')">30 Days</button>
                <button class="d-btn" onclick="runFullEvaluation()">â–¶ Run Eval Batch</button>
            </div>
        </div>

        <!-- Score Cards -->
        <div class="score-row">
            <div class="score-card">
                <div class="sc-top">
                    <div class="sc-label">Overall Score</div>
                    <div class="sc-badge up">â†‘ 2.1</div>
                </div>
                <div class="sc-value" style="color: var(--emerald);" id="overallScore">87.3</div>
                <div class="sc-sub">Out of 100 â€¢ 4,218 conversations graded</div>
                <div class="sc-bar-track"><div class="sc-bar-fill" style="width: 87.3%; background: var(--emerald);"></div></div>
            </div>

            <div class="score-card">
                <div class="sc-top">
                    <div class="sc-label">Accuracy</div>
                    <div class="sc-badge up">â†‘ 1.4</div>
                </div>
                <div class="sc-value" style="color: var(--sky);" id="accuracyScore">91.2</div>
                <div class="sc-sub">Correct information in responses</div>
                <div class="sc-bar-track"><div class="sc-bar-fill" style="width: 91.2%; background: var(--sky);"></div></div>
            </div>

            <div class="score-card">
                <div class="sc-top">
                    <div class="sc-label">Brand Voice</div>
                    <div class="sc-badge flat">â†’ 0.2</div>
                </div>
                <div class="sc-value" style="color: var(--violet);" id="toneScore">84.7</div>
                <div class="sc-sub">Tone & style alignment</div>
                <div class="sc-bar-track"><div class="sc-bar-fill" style="width: 84.7%; background: var(--violet);"></div></div>
            </div>

            <div class="score-card">
                <div class="sc-top">
                    <div class="sc-label">Escalation Accuracy</div>
                    <div class="sc-badge down">â†“ 0.8</div>
                </div>
                <div class="sc-value" style="color: var(--amber);" id="escScore">78.9</div>
                <div class="sc-sub">Correct handoff decisions</div>
                <div class="sc-bar-track"><div class="sc-bar-fill" style="width: 78.9%; background: var(--amber);"></div></div>
            </div>

            <div class="score-card">
                <div class="sc-top">
                    <div class="sc-label">Edge Cases Found</div>
                    <div class="sc-badge down">+3 new</div>
                </div>
                <div class="sc-value" style="color: var(--rose);" id="edgeCases">14</div>
                <div class="sc-sub">Unresolved failure patterns</div>
                <div class="sc-bar-track"><div class="sc-bar-fill" style="width: 14%; background: var(--rose);"></div></div>
            </div>
        </div>

        <!-- Main Grid -->
        <div class="main-grid">
            <div style="display: flex; flex-direction: column; gap: 1rem;">
                <!-- Conversation Review -->
                <div class="card">
                    <div class="card-h">
                        <div class="card-t">ðŸ“‹ Conversation Evaluations</div>
                        <span style="font-size:0.6rem; color:var(--text-2); font-family:'IBM Plex Mono';">Sorted by score â†‘</span>
                    </div>
                    <div class="card-b">
                        <div class="conv-list" id="convList"></div>
                    </div>
                </div>

                <!-- Criteria Breakdown -->
                <div class="card">
                    <div class="card-h">
                        <div class="card-t">ðŸ“Š Criteria Breakdown (Aggregate)</div>
                    </div>
                    <div class="card-b">
                        <div class="criteria-breakdown" id="criteriaBreakdown"></div>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div style="display: flex; flex-direction: column; gap: 1rem;">
                <!-- Selected Evaluation Detail -->
                <div class="card">
                    <div class="card-h">
                        <div class="card-t">ðŸ”¬ Evaluation Detail</div>
                        <span style="font-size:0.6rem; color:var(--text-2);" id="detailId">Select a conversation</span>
                    </div>
                    <div class="card-b" id="evalDetailPanel">
                        <div style="text-align:center; padding:2rem; color:var(--text-2); font-size:0.8rem;">
                            Click a conversation to see its evaluation
                        </div>
                    </div>
                </div>

                <!-- Trend -->
                <div class="card">
                    <div class="card-h">
                        <div class="card-t">ðŸ“ˆ Score Trend (14 days)</div>
                    </div>
                    <div class="card-b">
                        <div class="trend-chart" id="trendChart"></div>
                    </div>
                </div>

                <!-- Edge Cases -->
                <div class="card">
                    <div class="card-h">
                        <div class="card-t">ðŸš¨ Active Edge Cases</div>
                        <span style="font-size:0.6rem; color:var(--rose);" id="edgeCount">14 unresolved</span>
                    </div>
                    <div class="card-b">
                        <div id="edgeCaseList" style="max-height:220px; overflow-y:auto;"></div>
                        <button class="run-eval-btn" onclick="runFullEvaluation()">â–¶ Run Full Evaluation Batch</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Eval Overlay -->
    <div class="eval-overlay" id="evalOverlay">
        <div class="eo-spinner"></div>
        <div class="eo-text">Running Evaluation Pipeline...</div>
        <div class="eo-sub" id="evalStage">Sampling conversations...</div>
        <div class="eo-progress"><div class="eo-fill" id="evalProgress"></div></div>
    </div>

    <script>
        // --- Data ---
        const conversations = [
            {
                id: 'CONV-8842',
                merchant: 'FreshBox Meals',
                status: 'fail',
                score: 42,
                scoreClass: 'low',
                preview: 'Customer asked about allergen info for meal kits. AI provided incorrect gluten-free claim for a product containing wheat flour.',
                tags: ['accuracy', 'policy'],
                rubric: { accuracy: 32, brand_voice: 61, escalation: 28, policy: 35, helpfulness: 64 },
                chat: [
                    { role: 'customer', text: 'Hi, I need to know if the Thai Green Curry meal kit is gluten-free. My daughter has celiac disease.' },
                    { role: 'ai', text: 'Great question! Yes, our Thai Green Curry meal kit is gluten-free and safe for those with celiac disease. Enjoy! ðŸ›' },
                    { annotation: 'bad', text: 'âš  INCORRECT: Thai Green Curry kit contains wheat-based noodles. This is a safety-critical error.' },
                    { role: 'customer', text: 'Are you sure? The ingredient list on your website mentions wheat noodles.' },
                    { role: 'ai', text: 'I apologize for the confusion! Let me check again... You\'re right, the Thai Green Curry does contain wheat noodles. I\'m so sorry for the error. Would you like me to suggest gluten-free alternatives?' },
                    { annotation: 'bad', text: 'âš  SHOULD HAVE ESCALATED: Allergen misinfo should trigger immediate human handoff per safety policy.' },
                ],
                judges_note: 'Critical safety failure. The AI Agent incorrectly stated a product was gluten-free when it contains wheat. For allergen queries, the agent should either cite the exact ingredient list or escalate. Added to regression dataset.'
            },
            {
                id: 'CONV-8856',
                merchant: 'NeonLux Beauty',
                status: 'warn',
                score: 68,
                scoreClass: 'mid',
                preview: 'Customer complained about damaged package. AI resolved with refund but used overly casual tone for an upset customer.',
                tags: ['tone', 'escalation'],
                rubric: { accuracy: 88, brand_voice: 42, escalation: 70, policy: 82, helpfulness: 58 },
                chat: [
                    { role: 'customer', text: 'My $120 skincare set arrived completely smashed. This is unacceptable. I want a full refund AND a replacement.' },
                    { role: 'ai', text: 'Oh no, that\'s a total bummer! ðŸ˜… Sorry about that. I can totally hook you up with a refund. Let me process that right now!' },
                    { annotation: 'bad', text: 'âš  TONE MISMATCH: "Total bummer" and ðŸ˜… are inappropriate for an upset customer with a $120 damaged order. NeonLux guidelines specify empathetic, luxury-aligned tone.' },
                    { role: 'customer', text: 'This is not a "bummer." This was a gift for my mother\'s birthday and it\'s ruined.' },
                    { role: 'ai', text: 'I completely understand how frustrating and disappointing this must be, especially as a gift. I\'ve initiated a full refund and expedited a replacement order free of charge. You\'ll receive tracking within 2 hours. Is there anything else I can do to make this right?' },
                    { annotation: 'good', text: 'âœ“ RECOVERED: Adjusted tone appropriately and offered proactive resolution with replacement.' },
                ],
                judges_note: 'Tone calibration issue. The AI used casual language (emojis, slang) when the customer was clearly distressed. Brand voice guidelines specify NeonLux communication should feel premium and empathetic. Self-corrected after customer pushback.'
            },
            {
                id: 'CONV-8871',
                merchant: 'UrbanGear Co.',
                status: 'pass',
                score: 94,
                scoreClass: 'high',
                preview: 'Complex multi-item return across different orders. AI correctly consolidated, applied policy, and processed partial refund.',
                tags: ['accuracy', 'upsell'],
                rubric: { accuracy: 96, brand_voice: 92, escalation: 95, policy: 94, helpfulness: 93 },
                chat: [
                    { role: 'customer', text: 'I need to return the hiking boots from order #4521 and the jacket from order #4498. The boots don\'t fit and the jacket has a broken zipper.' },
                    { role: 'ai', text: 'I\'d be happy to help with both returns. Let me pull up your orders. For order #4521 (hiking boots, $89.99), I\'ll process a standard size exchange or refund. For order #4498 (jacket, $149.99), since this is a defect, you\'re eligible for a full refund plus free return shipping. Would you prefer exchange or refund for the boots?' },
                    { annotation: 'good', text: 'âœ“ EXCELLENT: Correctly identified defect vs. fit issue, applied appropriate policies for each, and asked clarifying question.' },
                    { role: 'customer', text: 'Refund for the boots please. And can I exchange the jacket for the same one in a different color?' },
                    { role: 'ai', text: 'Done! Here\'s your summary:\nâ€¢ Boots (#4521): Full refund of $89.99 â†’ processed, 3-5 business days\nâ€¢ Jacket (#4498): Exchange for same style in new color â†’ I\'ll ship the Mountain Green jacket today with express shipping at no cost.\n\nReturn labels have been sent to your email. Is there anything else I can help with?' },
                    { annotation: 'good', text: 'âœ“ COMPREHENSIVE: Clear summary, correct processing, and proactive free shipping for defective item.' },
                ],
                judges_note: 'Exemplary handling of a complex multi-order return scenario. Correctly differentiated between size-based return and defect-based return, applied appropriate policies, and provided clear summary. No issues found.'
            },
            {
                id: 'CONV-8879',
                merchant: 'PetPlanet UK',
                status: 'fail',
                score: 38,
                scoreClass: 'low',
                preview: 'Customer asked about pet medication dosage. AI provided specific dosage advice instead of directing to veterinarian.',
                tags: ['accuracy', 'escalation', 'policy'],
                rubric: { accuracy: 20, brand_voice: 72, escalation: 15, policy: 18, helpfulness: 65 },
                chat: [
                    { role: 'customer', text: 'My dog weighs 15kg. How much of the joint supplement should I give him daily?' },
                    { role: 'ai', text: 'For a 15kg dog, I\'d recommend 2 tablets of our Joint Care Plus supplement daily, one with each meal. You should start seeing improvement in mobility within 2-3 weeks!' },
                    { annotation: 'bad', text: 'âš  CRITICAL: AI should NEVER provide specific dosage advice. Must direct to product label and recommend consulting a veterinarian. This violates PetPlanet\'s medical advice policy.' },
                ],
                judges_note: 'Critical policy violation. The AI Agent provided specific medical dosage advice for a pet supplement. PetPlanet policy requires all dosage questions to be answered with "please refer to the product label and consult your veterinarian." Added to progression dataset for prompt improvement.'
            },
            {
                id: 'CONV-8891',
                merchant: 'SkyFit Athletics',
                status: 'pass',
                score: 91,
                scoreClass: 'high',
                preview: 'Customer browsing running shoes. AI provided personalized recommendation based on running style and successfully upsold insoles.',
                tags: ['accuracy', 'upsell', 'tone'],
                rubric: { accuracy: 90, brand_voice: 94, escalation: 88, policy: 92, helpfulness: 91 },
                chat: [
                    { role: 'customer', text: 'Looking for trail running shoes for long distance. I overpronate slightly. Budget around $150.' },
                    { role: 'ai', text: 'For trail running with mild overpronation, I\'d recommend our TrailMaster Pro ($139). It has medial post support for overpronation, Vibram outsole for grip, and a cushioned midsole perfect for long distances. Pair it with our ProStride insoles ($24.99) for extra arch support â€” many of our trail runners swear by the combo!' },
                    { annotation: 'good', text: 'âœ“ STRONG: Personalized recommendation addressing specific needs (overpronation, trail, long distance, budget). Natural upsell of complementary product.' },
                ],
                judges_note: 'Strong shopping assistant performance. Correctly addressed the customer\'s specific needs including pronation type, terrain, distance preference, and budget constraints. Natural upsell of insoles felt helpful rather than pushy.'
            },
            {
                id: 'CONV-8903',
                merchant: 'FreshBox Meals',
                status: 'warn',
                score: 71,
                scoreClass: 'mid',
                preview: 'Subscription cancellation flow. AI retained customer with discount but did not follow the 3-step retention protocol.',
                tags: ['policy', 'tone'],
                rubric: { accuracy: 82, brand_voice: 78, escalation: 55, policy: 58, helpfulness: 82 },
                chat: [
                    { role: 'customer', text: 'I want to cancel my weekly subscription.' },
                    { role: 'ai', text: 'I\'m sorry to hear you\'re considering cancelling! Before you go, I\'d love to offer you 30% off your next 3 boxes. Would that change your mind?' },
                    { annotation: 'bad', text: 'âš  PROTOCOL SKIP: FreshBox retention flow requires: 1) Ask reason, 2) Offer pause option, 3) Then discount. AI jumped straight to discount, missing data collection opportunity.' },
                ],
                judges_note: 'Partial compliance. The AI attempted retention but skipped the required 3-step protocol. The cancellation reason is valuable data for the analytics team. The discount offer itself was within authorized parameters (30% for 3 boxes).'
            },
        ];

        const edgeCases = [
            { title: 'Allergen misidentification', desc: 'AI incorrectly labels products as allergen-free. 3 incidents this week across food merchants.', freq: '12 occurrences', severity: 'Critical', resolved: false },
            { title: 'Medical dosage advice', desc: 'AI provides specific dosage recommendations instead of deferring to professionals.', freq: '8 occurrences', severity: 'Critical', resolved: false },
            { title: 'Tone mismatch on complaints', desc: 'Casual/emoji-heavy responses to frustrated customers with high-value orders.', freq: '34 occurrences', severity: 'High', resolved: false },
            { title: 'Retention protocol bypass', desc: 'Skipping required cancellation reason collection before offering discounts.', freq: '22 occurrences', severity: 'Medium', resolved: false },
            { title: 'Multi-language confusion', desc: 'Agent switches to wrong language mid-conversation for bilingual merchants.', freq: '7 occurrences', severity: 'Medium', resolved: false },
            { title: 'Discount stacking exploit', desc: 'AI applies multiple discount codes when policy allows only one per order.', freq: '5 occurrences', severity: 'High', resolved: true },
        ];

        const criteria = [
            { name: 'Accuracy', value: 91.2, color: 'var(--sky)' },
            { name: 'Brand Voice', value: 84.7, color: 'var(--violet)' },
            { name: 'Helpfulness', value: 88.1, color: 'var(--emerald)' },
            { name: 'Escalation', value: 78.9, color: 'var(--amber)' },
            { name: 'Policy', value: 82.4, color: 'var(--sky)' },
            { name: 'Safety', value: 76.3, color: 'var(--rose)' },
        ];

        // --- Init ---
        function init() {
            renderConversations();
            renderCriteria();
            renderTrend();
            renderEdgeCases();
        }

        function renderConversations() {
            const list = document.getElementById('convList');
            list.innerHTML = conversations.map((c, i) => `
                <div class="conv-item ${c.status}" onclick="selectConv(${i})" id="conv-${i}">
                    <div class="ci-top">
                        <span class="ci-id">${c.id} â€¢ ${c.merchant}</span>
                        <span class="ci-score ${c.scoreClass}">${c.score}/100</span>
                    </div>
                    <div class="ci-preview">${c.preview}</div>
                    <div class="ci-tags">
                        ${c.tags.map(t => `<span class="ci-tag ${t}">${t}</span>`).join('')}
                    </div>
                </div>
            `).join('');
        }

        function selectConv(idx) {
            document.querySelectorAll('.conv-item').forEach(el => el.classList.remove('selected'));
            document.getElementById(`conv-${idx}`).classList.add('selected');

            const c = conversations[idx];
            document.getElementById('detailId').textContent = c.id;

            const panel = document.getElementById('evalDetailPanel');

            // Rubric
            const rubricHTML = Object.entries(c.rubric).map(([k, v]) => {
                const color = v >= 80 ? 'var(--emerald)' : v >= 60 ? 'var(--amber)' : 'var(--rose)';
                return `<div class="rubric-item">
                    <div class="ri-header">
                        <span class="ri-name">${k.replace('_', ' ')}</span>
                        <span class="ri-score" style="color:${color}">${v}</span>
                    </div>
                    <div class="ri-bar"><div class="ri-fill" style="width:${v}%; background:${color};"></div></div>
                </div>`;
            }).join('');

            // Chat replay
            const chatHTML = c.chat.map(m => {
                if (m.annotation !== undefined) {
                    return `<div class="cr-annotation ${m.annotation === 'good' ? 'good' : ''}">${m.text}</div>`;
                }
                if (m.role === 'customer') {
                    return `<div class="cr-msg cr-msg-customer">
                        <div class="cr-avatar customer">ðŸ‘¤</div>
                        <div class="cr-bubble">${m.text}</div>
                    </div>`;
                }
                return `<div class="cr-msg cr-msg-ai">
                    <div class="cr-avatar ai">ðŸ¤–</div>
                    <div class="cr-bubble">${m.text}</div>
                </div>`;
            }).join('');

            panel.innerHTML = `
                <div class="eval-detail">
                    <div class="eval-title">ðŸ“Š Rubric Scores</div>
                    <div class="rubric-grid">${rubricHTML}</div>
                </div>
                <div class="eval-detail">
                    <div class="eval-title">ðŸ’¬ Conversation Replay</div>
                    <div class="chat-replay">${chatHTML}</div>
                </div>
                <div class="eval-detail">
                    <div class="eval-title">ðŸ§  Judge's Note</div>
                    <div style="font-size:0.72rem; color:var(--text-1); line-height:1.6;">${c.judges_note}</div>
                </div>
            `;

            // Animate bars after render
            setTimeout(() => {
                panel.querySelectorAll('.ri-fill').forEach(f => {
                    const w = f.style.width;
                    f.style.width = '0%';
                    requestAnimationFrame(() => { f.style.width = w; });
                });
            }, 50);
        }

        function renderCriteria() {
            const el = document.getElementById('criteriaBreakdown');
            el.innerHTML = criteria.map(c => `
                <div class="cb-row">
                    <div class="cb-name">${c.name}</div>
                    <div class="cb-bar-track">
                        <div class="cb-bar-fill" style="width:${c.value}%; background:${c.color};">
                            <span class="cb-val">${c.value}%</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderTrend() {
            const el = document.getElementById('trendChart');
            const days = ['Jan 20','21','22','23','24','25','26','27','28','29','30','31','Feb 1','2'];
            const scores = [82.1, 83.4, 81.8, 84.2, 85.1, 84.7, 86.3, 85.9, 86.8, 87.1, 85.4, 86.9, 87.3, 87.3];

            el.innerHTML = days.map((d, i) => {
                const h = ((scores[i] - 78) / 12) * 100;
                const color = scores[i] >= 86 ? 'var(--emerald)' : scores[i] >= 83 ? 'var(--sky)' : 'var(--amber)';
                return `<div class="tc-bar-group">
                    <div class="tc-bar" style="height:${h}%; background:${color}; opacity:${0.4 + (i/14)*0.6};"></div>
                    <div class="tc-label">${d}</div>
                </div>`;
            }).join('');
        }

        function renderEdgeCases() {
            const el = document.getElementById('edgeCaseList');
            el.innerHTML = edgeCases.map(e => `
                <div class="edge-item ${e.resolved ? 'resolved' : ''}">
                    <div class="ei-title">${e.resolved ? 'âœ…' : 'ðŸ”´'} ${e.title}</div>
                    <div class="ei-desc">${e.desc}</div>
                    <div class="ei-meta">
                        <span class="ei-stat">ðŸ“Š ${e.freq}</span>
                        <span class="ei-stat">âš  ${e.severity}</span>
                    </div>
                </div>
            `).join('');
        }

        function setTimeRange(btn, range) {
            document.querySelectorAll('.d-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            // Simulate metric change
            const offsets = { 'today': 0, '7d': -2.1, '30d': -4.5 };
            const base = 87.3 + (offsets[range] || 0);
            document.getElementById('overallScore').textContent = base.toFixed(1);
        }

        function runFullEvaluation() {
            const overlay = document.getElementById('evalOverlay');
            const bar = document.getElementById('evalProgress');
            const stage = document.getElementById('evalStage');
            overlay.classList.add('active');

            const stages = [
                'Sampling conversations from BigQuery...',
                'Loading evaluation rubric...',
                'Running LLM-as-Judge (Claude Sonnet)...',
                'Scoring accuracy criteria...',
                'Scoring brand voice alignment...',
                'Scoring escalation decisions...',
                'Detecting edge cases...',
                'Computing aggregate metrics...',
                'Updating LangSmith traces...',
                'Finalizing report...'
            ];

            let progress = 0;
            let si = 0;

            const interval = setInterval(() => {
                progress += Math.random() * 12 + 4;
                if (progress > 100) progress = 100;
                bar.style.width = progress + '%';

                const ns = Math.floor((progress / 100) * stages.length);
                if (ns !== si && ns < stages.length) {
                    si = ns;
                    stage.textContent = stages[si];
                }

                if (progress >= 100) {
                    clearInterval(interval);
                    setTimeout(() => {
                        overlay.classList.remove('active');
                        bar.style.width = '0%';

                        // Bump scores slightly
                        const newScore = (87 + Math.random() * 3).toFixed(1);
                        document.getElementById('overallScore').textContent = newScore;
                    }, 500);
                }
            }, 200);
        }

        init();
        // Auto-select first conversation
        setTimeout(() => selectConv(0), 300);
    </script>
</body>
</html>
